# ------------ Stage 1: Builder ------------
FROM python:3.10-slim as builder

# Install build tools required to compile torchvision dependencies
RUN apt update && apt install -y --no-install-recommends \
    gcc python3-dev wget && \
    \
    # Install CPU-only torch & torchvision
    pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir pillow && \
    \
    # Cleanup caches
    rm -rf /root/.cache/pip && \
    apt remove -y gcc python3-dev && apt autoremove -y && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy model + inference
COPY model.pt .
COPY inference.py .

# ------------ Stage 2: Runtime ------------
FROM python:3.10-slim

WORKDIR /app

# Copy just the Python packages
COPY --from=builder /usr/local/lib/python3.10/site-packages \
                    /usr/local/lib/python3.10/site-packages

# Copy Python binary itself
COPY --from=builder /usr/local/bin/python3 /usr/local/bin/python3

# Copy app files
COPY --from=builder /build .

ENTRYPOINT ["python3", "inference.py"]
